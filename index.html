<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="M·ªôt tr√≤ ch∆°i t∆∞∆°ng t√°c gi√∫p ng∆∞·ªùi d√πng h·ªçc ti·∫øng Anh b·∫±ng c√°ch nghe c√¢u v√† s·∫Øp x·∫øp c√°c t·ª´ theo ƒë√∫ng th·ª© t·ª±." />
    <title>Nghe v√† x·∫øp t·ª´ th√†nh c√¢u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Nunito', sans-serif;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-6px); }
        75% { transform: translateX(6px); }
      }
      .animate-shake {
        animation: shake 0.5s ease-in-out;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
</head>
<body>
    <noscript>B·∫°n c·∫ßn b·∫≠t JavaScript ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng n√†y.</noscript>
    <div id="root"></div>

    <script type="module">
      import React from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

      const { useState, useCallback, useMemo, useRef, useEffect } = React;

      // --- From types.ts ---
      const GameState = {
        Start: 0,
        TopicSelection: 1,
        Playing: 2,
        Congrats: 3,
      };

      // --- From data/topics.ts ---
      const topics = {
        "Sports & Activities": [
            { en: "Can you run very fast and score a goal?", vi: "B·∫°n c√≥ th·ªÉ ch·∫°y th·∫≠t nhanh v√† ghi b√†n kh√¥ng? üèÉ‚öΩ" },
            { en: "Today, I'd like to talk about football.", vi: "H√¥m nay, t√¥i mu·ªën n√≥i v·ªÅ b√≥ng ƒë√°. ‚öΩÔ∏è" },
            { en: "Football is an outdoor sport.", vi: "B√≥ng ƒë√° l√† m·ªôt m√¥n th·ªÉ thao ngo√†i tr·ªùi. üå≥" },
            { en: "You can play it on a field and the only thing you need is a ball.", vi: "B·∫°n c√≥ th·ªÉ ch∆°i n√≥ tr√™n s√¢n v√† th·ª© duy nh·∫•t b·∫°n c·∫ßn l√† m·ªôt qu·∫£ b√≥ng. ‚öΩ" },
            { en: "There are eleven players on each team for this sport.", vi: "C√≥ m∆∞·ªùi m·ªôt c·∫ßu th·ªß trong m·ªói ƒë·ªôi cho m√¥n th·ªÉ thao n√†y. üë®‚Äçüë®‚Äçüë¶‚Äçüë¶" },
            { en: "The playing time frame for this sport is 90 minutes.", vi: "Th·ªùi gian thi ƒë·∫•u c·ªßa m√¥n th·ªÉ thao n√†y l√† 90 ph√∫t. ‚è±Ô∏è" },
            { en: "You get a point every time you score a goal.", vi: "B·∫°n nh·∫≠n ƒë∆∞·ª£c m·ªôt ƒëi·ªÉm m·ªói khi b·∫°n ghi b√†n. ü•Ö" },
            { en: "The winner is the team with the most points!", vi: "ƒê·ªôi chi·∫øn th·∫Øng l√† ƒë·ªôi c√≥ nhi·ªÅu ƒëi·ªÉm nh·∫•t! üèÜ" },
            { en: "Players need to run very fast and they need to wear special trainers.", vi: "C√°c c·∫ßu th·ªß c·∫ßn ph·∫£i ch·∫°y r·∫•t nhanh v√† h·ªç c·∫ßn ph·∫£i ƒëi gi√†y chuy√™n d·ª•ng. üëü" },
            { en: "I think it's lots of fun!", vi: "T√¥i nghƒ© n√≥ r·∫•t vui! üòÑ" },
            { en: "With practise, you can be a great football player, just like me and my friends.", vi: "V·ªõi s·ª± luy·ªán t·∫≠p, b·∫°n c√≥ th·ªÉ tr·ªü th√†nh m·ªôt c·∫ßu th·ªß b√≥ng ƒë√° c·ª´ kh√¥i, gi·ªëng nh∆∞ t√¥i v√† c√°c b·∫°n c·ªßa t√¥i. üí™" },
            { en: "Why don't you try it?", vi: "T·∫°i sao b·∫°n kh√¥ng th·ª≠ n√≥? ü§î" },
            { en: "My favourite sport is football. It helps me feel good.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† b√≥ng ƒë√°. N√≥ gi√∫p t√¥i c·∫£m th·∫•y t·ªët. üòä" },
            { en: "My favourite sport is swimming. It helps me meet new people.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† b∆°i l·ªôi. N√≥ gi√∫p t√¥i g·∫∑p g·ª° nh·ªØng ng∆∞·ªùi m·ªõi. üèä‚Äç‚ôÄÔ∏è" },
            { en: "My favourite sport is badminton. It keeps me fit.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† c·∫ßu l√¥ng. N√≥ gi√∫p t√¥i gi·ªØ d√°ng. üè∏" },
            { en: "My favourite sport is basketball. It helps me forget about my worries.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† b√≥ng r·ªï. N√≥ gi√∫p t√¥i qu√™n ƒëi nh·ªØng lo l·∫Øng. üèÄ" },
            { en: "My favourite sport is martial arts. It teaches me to respect others.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† v√µ thu·∫≠t. N√≥ d·∫°y t√¥i t√¥n tr·ªçng ng∆∞·ªùi kh√°c. ü•ã" },
            { en: "My favourite sport is football. It keeps me fit, helps me meet new people, and makes me feel really good.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† b√≥ng ƒë√°. N√≥ gi√∫p t√¥i gi·ªØ d√°ng, g·∫∑p g·ª° nh·ªØng ng∆∞·ªùi m·ªõi v√† l√†m cho t√¥i c·∫£m th·∫•y th·ª±c s·ª± t·ªët. üëç" },
            { en: "My favourite sport is swimming. It helps me forget about my worries and keeps my body strong.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† b∆°i l·ªôi. N√≥ gi√∫p t√¥i qu√™n ƒëi nh·ªØng lo l·∫Øng v√† gi·ªØ cho c∆° th·ªÉ t√¥i kh·ªèe m·∫°nh. üí™" },
            { en: "My favourite sport is basketball. It helps me feel good and teaches me to respect others when I play in a team.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† b√≥ng r·ªï. N√≥ gi√∫p t√¥i c·∫£m th·∫•y t·ªët v√† d·∫°y t√¥i t√¥n tr·ªçng ng∆∞·ªùi kh√°c khi t√¥i ch∆°i trong m·ªôt ƒë·ªôi. ü§ù" },
            { en: "My favourite sport is cycling. It keeps me fit and helps me relax after a long day.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† ƒë·∫°p xe. N√≥ gi√∫p t√¥i gi·ªØ d√°ng v√† gi√∫p t√¥i th∆∞ gi√£n sau m·ªôt ng√†y d√†i. üö¥‚Äç‚ôÄÔ∏è" },
            { en: "My favourite sport is table tennis. It helps me meet new people, keeps me active, and makes me happy.", vi: "M√¥n th·ªÉ thao y√™u th√≠ch c·ªßa t√¥i l√† b√≥ng b√†n. N√≥ gi√∫p t√¥i g·∫∑p g·ª° nh·ªØng ng∆∞·ªùi m·ªõi, gi·ªØ cho t√¥i nƒÉng ƒë·ªông v√† l√†m cho t√¥i h·∫°nh ph√∫c. üòÑ" },
            { en: "I think that people should play a sport because it helps keep you fit.", vi: "T√¥i nghƒ© r·∫±ng m·ªçi ng∆∞·ªùi n√™n ch∆°i m·ªôt m√¥n th·ªÉ thao v√¨ n√≥ gi√∫p b·∫°n gi·ªØ d√°ng. üèÉ‚Äç‚ôÇÔ∏è" },
            { en: "It's important to play a sport to get moving and stay healthy.", vi: "Ch∆°i th·ªÉ thao ƒë·ªÉ v·∫≠n ƒë·ªông v√† gi·ªØ g√¨n s·ª©c kh·ªèe l√† ƒëi·ªÅu quan tr·ªçng. ‚ù§Ô∏è" },
            { en: "When you go rollerblading, you need rollerblades and a helmet.", vi: "Khi b·∫°n ƒëi tr∆∞·ª£t patin, b·∫°n c·∫ßn gi√†y tr∆∞·ª£t v√† m≈© b·∫£o hi·ªÉm. ‚õ∏Ô∏è" },
            { en: "When you play basketball, you need a ball and a hoop.", vi: "Khi b·∫°n ch∆°i b√≥ng r·ªï, b·∫°n c·∫ßn m·ªôt qu·∫£ b√≥ng v√† m·ªôt c√°i r·ªï. üèÄ" },
            { en: "When you do yoga, you need a mat.", vi: "Khi b·∫°n t·∫≠p yoga, b·∫°n c·∫ßn m·ªôt t·∫•m th·∫£m. üßò‚Äç‚ôÄÔ∏è" },
            { en: "When you go snorkelling, you need flippers, a snorkel and a wetsuit.", vi: "Khi b·∫°n ƒëi l·∫∑n v·ªõi ·ªëng th·ªü, b·∫°n c·∫ßn ch√¢n v·ªãt, ·ªëng th·ªü v√† ƒë·ªì l·∫∑n. ü§ø" },
            { en: "When you do kickboxing, you need a punchbag and boxing gloves.", vi: "Khi b·∫°n t·∫≠p kickboxing, b·∫°n c·∫ßn m·ªôt bao c√°t v√† gƒÉng tay ƒë·∫•m b·ªëc. ü•ä" },
            { en: "At my school, we celebrate School Sports Day every September.", vi: "T·∫°i tr∆∞·ªùng c·ªßa t√¥i, ch√∫ng t√¥i t·ªï ch·ª©c Ng√†y h·ªôi th·ªÉ thao c·ªßa tr∆∞·ªùng v√†o m·ªói th√°ng Ch√≠n. üè´" },
            { en: "It takes place on our school playing field.", vi: "N√≥ di·ªÖn ra tr√™n s√¢n ch∆°i c·ªßa tr∆∞·ªùng ch√∫ng t√¥i. üèüÔ∏è" },
            { en: "The day starts with an aerobics class and some team building games.", vi: "Ng√†y b·∫Øt ƒë·∫ßu v·ªõi m·ªôt l·ªõp th·ªÉ d·ª•c nh·ªãp ƒëi·ªáu v√† m·ªôt s·ªë tr√≤ ch∆°i x√¢y d·ª±ng ƒë·ªôi nh√≥m. üíÉ" },
            { en: "Then, we compete in running races and other sports.", vi: "Sau ƒë√≥, ch√∫ng t√¥i thi ƒë·∫•u trong c√°c cu·ªôc ƒëua ch·∫°y v√† c√°c m√¥n th·ªÉ thao kh√°c. üèÉ‚Äç‚ôÄÔ∏è" },
            { en: "The long jump is my favourite because I've got long legs and I usually win.", vi: "Nh·∫£y xa l√† m√¥n y√™u th√≠ch c·ªßa t√¥i v√¨ t√¥i c√≥ ƒë√¥i ch√¢n d√†i v√† t√¥i th∆∞·ªùng chi·∫øn th·∫Øng. ü•á" },
            { en: "School Sports Day is always a fantastic day.", vi: "Ng√†y h·ªôi th·ªÉ thao c·ªßa tr∆∞·ªùng lu√¥n l√† m·ªôt ng√†y tuy·ªát v·ªùi. üéâ" },
            { en: "Even students that don't like sport enjoy themselves!", vi: "Ngay c·∫£ nh·ªØng h·ªçc sinh kh√¥ng th√≠ch th·ªÉ thao c≈©ng c·∫£m th·∫•y vui v·∫ª! üòä" },
            { en: "He used to play tennis at college.", vi: "Anh ·∫•y t·ª´ng ch∆°i tennis ·ªü tr∆∞·ªùng ƒë·∫°i h·ªçc. üéæ" },
            { en: "Did they use to walk to school?", vi: "H·ªç c√≥ t·ª´ng ƒëi b·ªô ƒë·∫øn tr∆∞·ªùng kh√¥ng? ü§î" },
            { en: "We used to go to basketball practice yesterday.", vi: "H√¥m qua ch√∫ng t√¥i ƒë√£ t·ª´ng ƒëi t·∫≠p b√≥ng r·ªï. üèÄ" },
            { en: "Sandra didn't use to play badminton.", vi: "Sandra ƒë√£ kh√¥ng t·ª´ng ch∆°i c·∫ßu l√¥ng. üè∏" }
        ],
        "Health & Body": [
            { en: "Penny has got a cold and a cough.", vi: "Penny b·ªã c·∫£m l·∫°nh v√† ho. ü§ß" },
            { en: "Steve ate too many sweets and now he has got a stomach ache.", vi: "Steve ƒë√£ ƒÉn qu√° nhi·ªÅu ƒë·ªì ng·ªçt v√† b√¢y gi·ªù anh ·∫•y b·ªã ƒëau b·ª•ng. üç¨ü§¢" },
            { en: "Ann has got a sore throat. It hurts when she swallows.", vi: "Ann b·ªã ƒëau h·ªçng. C√¥ ·∫•y b·ªã ƒëau khi nu·ªët. ü§í" },
            { en: "Mike has got a headache. He worked on his computer too much.", vi: "Mike b·ªã ƒëau ƒë·∫ßu. Anh ·∫•y ƒë√£ l√†m vi·ªác tr√™n m√°y t√≠nh qu√° nhi·ªÅu. üíªü§ï" },
            { en: "Jane has got a temperature. Her forehead is really hot.", vi: "Jane b·ªã s·ªët. Tr√°n c·ªßa c√¥ ·∫•y r·∫•t n√≥ng. üå°Ô∏è" },
            { en: "Our bodies have more bone than water.", vi: "C∆° th·ªÉ ch√∫ng ta c√≥ nhi·ªÅu x∆∞∆°ng h∆°n n∆∞·ªõc. ü¶¥" },
            { en: "We lose a lot of our water when we exercise.", vi: "Ch√∫ng ta m·∫•t r·∫•t nhi·ªÅu n∆∞·ªõc khi t·∫≠p th·ªÉ d·ª•c. üíß" },
            { en: "Our skin doesn't change when we drink water.", vi: "Da c·ªßa ch√∫ng ta kh√¥ng thay ƒë·ªïi khi ch√∫ng ta u·ªëng n∆∞·ªõc. ü§î" },
            { en: "Experts think eight glasses of water per day is too much.", vi: "C√°c chuy√™n gia cho r·∫±ng t√°m ly n∆∞·ªõc m·ªói ng√†y l√† qu√° nhi·ªÅu. üë®‚Äç‚öïÔ∏è" },
            { en: "I used to drink lots of fizzy drinks like cola and soda, but last year I changed my habit.", vi: "T√¥i ƒë√£ t·ª´ng u·ªëng r·∫•t nhi·ªÅu ƒë·ªì u·ªëng c√≥ ga nh∆∞ cola v√† soda, nh∆∞ng nƒÉm ngo√°i t√¥i ƒë√£ thay ƒë·ªïi th√≥i quen c·ªßa m√¨nh. ü•§" },
            { en: "I started drinking lots of water because it is important to our bodies.", vi: "T√¥i b·∫Øt ƒë·∫ßu u·ªëng nhi·ªÅu n∆∞·ªõc v√¨ n√≥ quan tr·ªçng ƒë·ªëi v·ªõi c∆° th·ªÉ ch√∫ng ta.üíß" },
            { en: "Our bodies are about 60% water.", vi: "C∆° th·ªÉ ch√∫ng ta c√≥ kho·∫£ng 60% l√† n∆∞·ªõc. üíß" },
            { en: "That means we have more water than bone.", vi: "ƒêi·ªÅu ƒë√≥ c√≥ nghƒ©a l√† ch√∫ng ta c√≥ nhi·ªÅu n∆∞·ªõc h∆°n x∆∞∆°ng. üíß" },
            { en: "When we exercise, our bodies lose up to 10% of their water.", vi: "Khi ch√∫ng ta t·∫≠p th·ªÉ d·ª•c, c∆° th·ªÉ ch√∫ng ta m·∫•t t·ªõi 10% l∆∞·ª£ng n∆∞·ªõc. üí¶" },
            { en: "We need to drink more to replace that water and perform well.", vi: "Ch√∫ng ta c·∫ßn u·ªëng nhi·ªÅu h∆°n ƒë·ªÉ thay th·∫ø l∆∞·ª£ng n∆∞·ªõc ƒë√≥ v√† ho·∫°t ƒë·ªông t·ªët. üëç" },
            { en: "Drinking water also helps our brain work better.", vi: "U·ªëng n∆∞·ªõc c≈©ng gi√∫p n√£o c·ªßa ch√∫ng ta ho·∫°t ƒë·ªông t·ªët h∆°n. üß†" },
            { en: "Our skin looks brighter and our body temperature stays the same even on a hot day, all because of the water inside us.", vi: "Da c·ªßa ch√∫ng ta tr√¥ng s√°ng h∆°n v√† nhi·ªát ƒë·ªô c∆° th·ªÉ c·ªßa ch√∫ng ta kh√¥ng ƒë·ªïi ngay c·∫£ trong m·ªôt ng√†y n√≥ng, t·∫•t c·∫£ l√† do n∆∞·ªõc b√™n trong ch√∫ng ta. ‚ú®" },
            { en: "So how much water should we drink?", vi: "V·∫≠y ch√∫ng ta n√™n u·ªëng bao nhi√™u n∆∞·ªõc? ü§î" },
            { en: "Most experts suggest around eight glasses a day.", vi: "H·∫ßu h·∫øt c√°c chuy√™n gia ƒë·ªÅ ngh·ªã kho·∫£ng t√°m ly m·ªói ng√†y. ü•õ" },
            { en: "Other drinks such as tea, milk and fresh fruit juice are OK too.", vi: "C√°c ƒë·ªì u·ªëng kh√°c nh∆∞ tr√†, s·ªØa v√† n∆∞·ªõc tr√°i c√¢y t∆∞∆°i c≈©ng ƒë∆∞·ª£c. üçµ" },
            { en: "What about you?", vi: "C√≤n b·∫°n th√¨ sao? üòä" },
            { en: "Do you drink enough water?", vi: "B·∫°n c√≥ u·ªëng ƒë·ªß n∆∞·ªõc kh√¥ng? ü§î" },
            { en: "Alex started drinking fizzy drinks last year.", vi: "Alex b·∫Øt ƒë·∫ßu u·ªëng ƒë·ªì u·ªëng c√≥ ga v√†o nƒÉm ngo√°i. ü•§" }
        ],
        "Daily Life & Questions": [
            { en: "How much milk do we have?", vi: "Ch√∫ng ta c√≥ bao nhi√™u s·ªØa? ü•õ" },
            { en: "I need to buy some bread at the supermarket.", vi: "T√¥i c·∫ßn mua m·ªôt √≠t b√°nh m√¨ ·ªü si√™u th·ªã. üçû" },
            { en: "There are only a few grapes left.", vi: "Ch·ªâ c√≤n l·∫°i v√†i qu·∫£ nho. üçá" },
            { en: "We don't have any orange juice for breakfast.", vi: "Ch√∫ng t√¥i kh√¥ng c√≥ n∆∞·ªõc cam n√†o cho b·ªØa s√°ng. üçä" },
            { en: "Can I have some orange juice for breakfast?", vi: "T√¥i c√≥ th·ªÉ u·ªëng m·ªôt √≠t n∆∞·ªõc cam cho b·ªØa s√°ng kh√¥ng? ü•§" },
            { en: "There are lots of strawberries in the fridge.", vi: "C√≥ r·∫•t nhi·ªÅu d√¢u t√¢y trong t·ªß l·∫°nh. üçì" },
            { en: "Where did you see the poster about sports day?", vi: "B·∫°n ƒë√£ th·∫•y t·∫•m √°p ph√≠ch v·ªÅ ng√†y h·ªôi th·ªÉ thao ·ªü ƒë√¢u? ü§î" },
            { en: "I went to the British Museum last Sunday.", vi: "T√¥i ƒë√£ ƒë·∫øn B·∫£o t√†ng Anh v√†o Ch·ªß nh·∫≠t tu·∫ßn tr∆∞·ªõc. üèõÔ∏è" },
            { en: "Who ran in a marathon last week?", vi: "Ai ƒë√£ ch·∫°y marathon v√†o tu·∫ßn tr∆∞·ªõc? üèÉ‚Äç‚ôÄÔ∏è" },
            { en: "The children didn't want to go to the cinema.", vi: "B·ªçn tr·∫ª kh√¥ng mu·ªën ƒëi xem phim. üé¨" },
            { en: "When did she leave? An hour ago.", vi: "C√¥ ·∫•y ƒë√£ r·ªùi ƒëi khi n√†o? M·ªôt gi·ªù tr∆∞·ªõc. ‚è∞" },
            { en: "Who did Jane watch the race with? Susan.", vi: "Jane ƒë√£ xem cu·ªôc ƒëua v·ªõi ai? Susan. üë≠" },
            { en: "When did Sam lose his bag?", vi: "Sam ƒë√£ l√†m m·∫•t t√∫i c·ªßa m√¨nh khi n√†o? üéí" },
            { en: "She fell off a ladder last week.", vi: "C√¥ ·∫•y ƒë√£ b·ªã ng√£ kh·ªèi thang v√†o tu·∫ßn tr∆∞·ªõc. ü™ú" }
        ]
      };


      // --- From hooks/useSpeechSynthesis.ts ---
      const useSpeechSynthesis = () => {
        const [isSpeaking, setIsSpeaking] = useState(false);
        const [voices, setVoices] = useState([]);
        const utteranceRef = useRef(null);

        const updateVoices = useCallback(() => {
          if ('speechSynthesis' in window) {
            const availableVoices = window.speechSynthesis.getVoices();
            const englishVoices = availableVoices.filter(voice => voice.lang.startsWith('en'));
            setVoices(englishVoices);
          }
        }, []);

        useEffect(() => {
          if ('speechSynthesis' in window) {
            updateVoices();
            window.speechSynthesis.onvoiceschanged = updateVoices;
            return () => {
              if (window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = null;
              }
            }
          }
        }, [updateVoices]);

        const cancel = useCallback(() => {
          if (window.speechSynthesis) {
              window.speechSynthesis.cancel();
          }
        }, []);

        useEffect(() => {
          return () => {
              cancel();
          }
        }, [cancel]);

        const speak = useCallback((text, options = {}) => {
          cancel();
          
          if (!('speechSynthesis' in window)) {
              console.warn("Speech Synthesis not supported in this browser.");
              if (options.onEnd) options.onEnd();
              return;
          }
          
          const { rate = 1.0, onBoundary, onEnd, voice } = options;

          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          utterance.rate = rate;
          if (voice) {
            utterance.voice = voice;
          }
          utteranceRef.current = utterance;

          utterance.onstart = () => setIsSpeaking(true);
          
          if (onBoundary) {
            utterance.onboundary = (event) => {
              if (event.name === 'word') {
                const words = text.split(' ');
                let cumulativeLength = 0;
                for (let i = 0; i < words.length; i++) {
                  cumulativeLength += words[i].length + 1; // Add length of word + 1 for the space
                  if (event.charIndex < cumulativeLength) {
                      onBoundary(i);
                      return; // Exit loop once the word is found
                  }
                }
              }
            };
          }

          utterance.onend = () => {
            setIsSpeaking(false);
            utteranceRef.current = null;
            if (onEnd) onEnd();
          };

          utterance.onerror = (event) => {
            if (event.error !== 'interrupted') {
              console.error('SpeechSynthesis Error:', event.error);
            }
            setIsSpeaking(false);
            utteranceRef.current = null;
            if (onEnd) onEnd();
          };
          
          setTimeout(() => {
              window.speechSynthesis.speak(utterance);
          }, 50);

        }, [cancel]);

        return { speak, cancel, isSpeaking, voices };
      };

      // --- From components/Fireworks.tsx ---
      const Fireworks = () => {
        const canvasRef = useRef(null);
        const animationFrameId = useRef();
        const particles = useRef([]);

        const createParticle = (x, y) => {
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 6 + 2;
          return {
            x, y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            color: `hsl(${Math.random() * 360}, 100%, 70%)`,
            size: Math.random() * 3 + 1,
            life: 1,
            fade: 0.02,
          };
        };

        const createExplosion = () => {
          if (!canvasRef.current) return;
          const x = Math.random() * canvasRef.current.width;
          const y = Math.random() * canvasRef.current.height / 2;
          for (let i = 0; i < 50; i++) {
            particles.current.push(createParticle(x, y));
          }
        };

        const animate = () => {
          if (!canvasRef.current) return;
          const ctx = canvasRef.current.getContext('2d');
          if (!ctx) return;
          
          ctx.globalCompositeOperation = 'source-over';
          ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
          ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height);
          ctx.globalCompositeOperation = 'lighter';
          
          particles.current = particles.current.filter(p => p.life > 0);

          particles.current.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.05;
            p.life -= p.fade;
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fillStyle = `hsla(${p.color.match(/\\d+/)?.[0]}, 100%, 70%, ${p.life})`;
            ctx.fill();
          });

          animationFrameId.current = requestAnimationFrame(animate);
        };

        useEffect(() => {
          const canvas = canvasRef.current;
          if (canvas) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const handleResize = () => {
              canvas.width = window.innerWidth;
              canvas.height = window.innerHeight;
            };
            window.addEventListener('resize', handleResize);
            
            const intervalIds = [];
            for(let i = 0; i < 5; i++) {
                intervalIds.push(setTimeout(() => createExplosion(), Math.random() * 1000));
            }
            const mainInterval = setInterval(createExplosion, 500 + Math.random() * 500);
            intervalIds.push(mainInterval);
            animate();
            return () => {
              window.removeEventListener('resize', handleResize);
              if (animationFrameId.current) cancelAnimationFrame(animationFrameId.current);
              intervalIds.forEach(clearInterval);
              particles.current = [];
            };
          }
        }, []);

        return React.createElement('canvas', { ref: canvasRef, className: "fixed top-0 left-0 w-full h-full pointer-events-none z-50" });
      };

      // --- From components/TopicCongratsScreen.tsx ---
      const TopicCongratsScreen = ({
        playerName, topicName, correctCount, totalCount, onPlayAgain, onChooseAnotherTopic,
      }) => {
        return React.createElement('div', { className: "relative flex flex-col items-center gap-6 text-center p-4 animate-fade-in" },
          React.createElement(Fireworks),
          React.createElement('div', { className: "text-2xl sm:text-3xl md:text-4xl text-green-600 font-extrabold" },
            React.createElement('p', null, "Ch√∫c m·ª´ng ", React.createElement('strong', { className: "text-purple-600" }, playerName), "!"),
            React.createElement('p', { className: "mt-2" }, `B·∫°n ƒë√£ ho√†n th√†nh ch·ªß ƒë·ªÅ "${topicName}".`)
          ),
          React.createElement('p', { className: "text-xl sm:text-2xl text-slate-700 font-semibold" }, `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${correctCount}/${totalCount} c√¢u.`),
          React.createElement('div', { className: "flex flex-col sm:flex-row gap-4 mt-6 w-full max-w-md" },
            React.createElement('button', {
              onClick: onPlayAgain,
              className: "w-full p-4 text-xl rounded-2xl bg-blue-500 text-white font-bold transform hover:scale-105 hover:bg-blue-600 transition-all shadow-lg"
            }, "Ch∆°i l·∫°i ch·ªß ƒë·ªÅ n√†y"),
            React.createElement('button', {
              onClick: onChooseAnotherTopic,
              className: "w-full p-4 text-xl rounded-2xl bg-orange-500 text-white font-bold transform hover:scale-105 hover:bg-orange-600 transition-all shadow-lg"
            }, "Ch·ªçn ch·ªß ƒë·ªÅ kh√°c")
          )
        );
      };

      // --- From components/StartScreen.tsx ---
      const StartScreen = ({ onStart }) => {
        const [name, setName] = useState('');
        const handleStartClick = () => {
          if (name.trim()) {
            onStart(name.trim());
          } else {
            alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu!');
          }
        };
        const handleKeyPress = (event) => {
          if (event.key === 'Enter') handleStartClick();
        };

        return React.createElement('div', { className: "flex flex-col items-center gap-6 animate-fade-in" },
          React.createElement('input', {
            type: "text",
            value: name,
            onChange: (e) => setName(e.target.value),
            onKeyPress: handleKeyPress,
            placeholder: "Nh·∫≠p t√™n c·ªßa b·∫°n...",
            className: "font-nunito text-lg sm:text-xl p-3 px-5 rounded-2xl border-2 border-purple-400 text-center w-full max-w-sm focus:outline-none focus:ring-4 focus:ring-purple-300 transition-shadow shadow-inner"
          }),
          React.createElement('button', {
            onClick: handleStartClick,
            className: "p-4 px-10 text-xl sm:text-2xl rounded-2xl w-full max-w-sm bg-green-500 text-white font-bold transform hover:scale-105 hover:bg-green-600 active:scale-100 transition-all shadow-lg hover:shadow-xl"
          }, "B·∫Øt ƒë·∫ßu")
        );
      };

      // --- From components/TopicSelectionScreen.tsx ---
      const topicColors = [
        'from-red-500 to-red-600', 'from-blue-500 to-blue-600', 'from-green-500 to-green-600',
        'from-orange-500 to-orange-600', 'from-cyan-500 to-cyan-600', 'from-pink-500 to-pink-600',
      ];
      const TopicSelectionScreen = ({ topics, onSelectTopic }) => {
        return React.createElement('div', { className: "flex flex-col items-center gap-4 w-full animate-fade-in" },
          React.createElement('h2', { className: "text-2xl sm:text-3xl font-bold mb-4 text-slate-700" }, "Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ ƒë·ªÉ h·ªçc:"),
          React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-5 w-full max-w-2xl" },
            topics.map((topic, index) => (
              React.createElement('button', {
                key: topic,
                onClick: () => onSelectTopic(topic),
                className: `p-4 text-lg text-white font-bold rounded-2xl transform hover:-translate-y-1 transition-all shadow-lg hover:shadow-xl bg-gradient-to-br ${topicColors[index % topicColors.length]}`
              }, topic)
            ))
          )
        );
      };

      // --- From components/GameScreen.tsx ---
      const shuffle = (array) => {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      };
      const pastelColors = [
        'bg-sky-200 border-sky-400 text-sky-800 hover:bg-sky-300 hover:border-sky-500',
        'bg-emerald-200 border-emerald-400 text-emerald-800 hover:bg-emerald-300 hover:border-emerald-500',
        'bg-rose-200 border-rose-400 text-rose-800 hover:bg-rose-300 hover:border-rose-500',
        'bg-amber-200 border-amber-400 text-amber-800 hover:bg-amber-300 hover:border-amber-500',
        'bg-violet-200 border-violet-400 text-violet-800 hover:bg-violet-300 hover:border-violet-500',
        'bg-teal-200 border-teal-400 text-teal-800 hover:bg-teal-300 hover:border-teal-500',
      ];
      const GameScreen = ({ sentences, onTopicComplete, onChooseAnotherTopic }) => {
        const [currentIndex, setCurrentIndex] = useState(0);
        const [currentWords, setCurrentWords] = useState([]);
        const [shuffledWords, setShuffledWords] = useState([]);
        const [playerAnswer, setPlayerAnswer] = useState([]);
        const [mistakeCount, setMistakeCount] = useState(0);
        const [incorrectWord, setIncorrectWord] = useState(null);
        const [message, setMessage] = useState(null);
        const [score, setScore] = useState(0);
        const [correctlyAnswered, setCorrectlyAnswered] = useState(0);
        const [isSentenceDone, setIsSentenceDone] = useState(false);
        const [highlightedIndex, setHighlightedIndex] = useState(-1);
        const allowSecondPlay = useRef(true);
        const { speak, cancel, isSpeaking, voices } = useSpeechSynthesis();
        const [selectedVoiceURI, setSelectedVoiceURI] = useState(null);
        
        const selectedVoice = useMemo(() => {
          if (!voices || voices.length === 0) return null;
          if (selectedVoiceURI) {
            return voices.find(v => v.voiceURI === selectedVoiceURI);
          }
          return voices.find(v => v.name === 'Google US English') || voices.find(v => v.default) || voices[0];
        }, [voices, selectedVoiceURI]);

        useEffect(() => {
            if (voices.length > 0 && !selectedVoiceURI) {
                const defaultVoice = voices.find(v => v.name === 'Google US English') || voices.find(v => v.default) || voices[0];
                if (defaultVoice) {
                    setSelectedVoiceURI(defaultVoice.voiceURI);
                }
            }
        }, [voices, selectedVoiceURI]);

        const currentSentence = useMemo(() => sentences[currentIndex], [sentences, currentIndex]);

        const startNewSentence = useCallback(() => {
          if (currentIndex >= sentences.length) {
            onTopicComplete(correctlyAnswered, sentences.length);
            return;
          }
          setIsSentenceDone(false);
          setPlayerAnswer([]);
          setMistakeCount(0);
          setMessage(null);
          setHighlightedIndex(-1);
          const cleanSentence = sentences[currentIndex].en.replace(/[.!?]$/, '');
          const words = cleanSentence.split(' ');
          setCurrentWords(words);
          setShuffledWords(shuffle(words));
          allowSecondPlay.current = true;
          
          const speakOptions = { rate: 0.9, voice: selectedVoice };

          speak(sentences[currentIndex].en, {
              ...speakOptions,
              onEnd: () => {
                  if (allowSecondPlay.current) {
                      setTimeout(() => {
                          if (allowSecondPlay.current) speak(sentences[currentIndex].en, speakOptions);
                      }, 400);
                  }
              }
          });
        }, [currentIndex, sentences, onTopicComplete, correctlyAnswered, speak, selectedVoice]);
        
        const stopPendingActions = useCallback(() => {
          allowSecondPlay.current = false;
          cancel();
        }, [cancel]);

        useEffect(() => {
          startNewSentence();
          return stopPendingActions;
        }, [currentIndex]);
        
        useEffect(() => {
          return stopPendingActions;
        }, [stopPendingActions]);

        const handleListenAgain = () => {
          if (currentSentence) {
              stopPendingActions();
              speak(currentSentence.en, { rate: 0.9, voice: selectedVoice });
          }
        };

        const handleWordClick = (word, index) => {
          if (isSentenceDone) return;
          stopPendingActions();
          const correctWord = currentWords[playerAnswer.length];
          if (word === correctWord) {
            setPlayerAnswer([...playerAnswer, word]);
            setShuffledWords(prev => {
              const newArr = [...prev];
              const wordIndex = newArr.findIndex((w, i) => w === word && i === index);
              if (wordIndex > -1) newArr[wordIndex] = '';
              return newArr;
            });
            setMessage(null);
            if (playerAnswer.length + 1 === currentWords.length) {
              setIsSentenceDone(true);
              let newScore = score;
              let newCorrectlyAnswered = correctlyAnswered;
              if (mistakeCount <= 2) {
                newScore += 10;
                newCorrectlyAnswered++;
                setScore(newScore);
                setCorrectlyAnswered(newCorrectlyAnswered);
                setMessage({ text: 'Ch√≠nh x√°c! +10 ƒëi·ªÉm.', type: 'success' });
              } else {
                setMessage({ text: `B·∫°n ƒë√£ sai ${mistakeCount} l·∫ßn, kh√¥ng ƒë∆∞·ª£c c·ªông ƒëi·ªÉm c√¢u n√†y.`, type: 'error' });
              }
              speak(currentSentence.en, { 
                  voice: selectedVoice,
                  onBoundary: (wordIndex) => setHighlightedIndex(wordIndex),
                  onEnd: () => {
                    setHighlightedIndex(-1);
                    setTimeout(() => setCurrentIndex(prev => prev + 1), 2000);
                  }
              });
            }
          } else {
            setMistakeCount(prev => prev + 1);
            setIncorrectWord(`${word}-${index}`);
            setMessage({ text: `Sai r·ªìi! (S·ªë l·∫ßn sai: ${mistakeCount + 1})`, type: 'error' });
            setTimeout(() => setIncorrectWord(null), 500);
          }
        };

        return React.createElement('div', { className: "flex flex-col items-center gap-2 w-full animate-fade-in" },
          React.createElement('div', { className: "w-full text-center bg-purple-100/70 p-3 rounded-2xl" },
            React.createElement('div', { className: "text-xl sm:text-2xl text-purple-900 italic font-semibold" }, `‚Äú${currentSentence?.vi}‚Äù`)
          ),
          React.createElement('div', { className: "text-2xl sm:text-3xl font-bold mt-2 mb-1 min-h-[100px] bg-violet-50 p-4 rounded-xl shadow-inner w-full flex items-center justify-center flex-wrap gap-x-2.5 gap-y-3" },
            isSentenceDone ? 
              currentSentence.en.split(' ').map((word, index) => React.createElement('span', { key: index, className: `inline-block px-1 py-1 rounded-md transition-all duration-200 ${highlightedIndex === index ? 'bg-yellow-300 text-black scale-110' : 'bg-transparent text-slate-800 scale-100'}`}, word)) :
              currentWords.map((_, index) => React.createElement('div', { key: index, className: `h-16 w-24 flex items-center justify-center text-xl font-semibold p-2 rounded-lg ${playerAnswer[index] ? 'bg-purple-200 border-2 border-purple-500 text-purple-900' : 'bg-slate-200 border-2 border-dashed border-slate-400'}`}, playerAnswer[index]))
          ),
          React.createElement('div', { className: "min-h-[30px] text-xl font-bold" },
            message && React.createElement('p', { className: `${message.type === 'success' ? 'text-green-600' : 'text-red-500'}` }, message.text)
          ),
          React.createElement('div', { className: "flex flex-wrap justify-center gap-3 mt-1 mb-4 w-full min-h-[120px]" },
            shuffledWords.map((word, index) => {
              const isUsed = word === '';
              const isIncorrect = incorrectWord === `${word}-${index}`;
              const pastelColor = pastelColors[index % pastelColors.length];
              return React.createElement('button', {
                key: index,
                onClick: () => handleWordClick(word, index),
                disabled: isUsed || isSentenceDone,
                className: `text-xl font-bold py-3 px-5 rounded-xl border-b-4 transition-all duration-150 transform active:translate-y-0.5 active:border-b-2 ${isUsed ? 'opacity-0 pointer-events-none' : 'opacity-100'} ${isIncorrect ? 'border-red-500 animate-shake bg-red-100 text-red-600' : `${pastelColor} hover:-translate-y-1 hover:shadow-md`} ${isSentenceDone ? 'cursor-not-allowed' : ''}`
              }, word);
            })
          ),
          React.createElement('div', { className: "flex flex-wrap justify-center items-center gap-4 my-4" },
            React.createElement('button', { onClick: handleListenAgain, disabled: isSentenceDone || isSpeaking, className: "py-3 px-8 text-lg font-bold bg-purple-600 text-white rounded-xl shadow-md transform hover:-translate-y-1 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none" }, "Nghe l·∫°i"),
             React.createElement('div', { className: "relative" },
                React.createElement('select', {
                  value: selectedVoiceURI || '',
                  onChange: (e) => setSelectedVoiceURI(e.target.value),
                  disabled: voices.length === 0 || isSpeaking,
                  'aria-label': "Ch·ªçn gi·ªçng ƒë·ªçc",
                  className: "py-3 px-5 text-lg font-bold bg-white text-slate-800 rounded-xl shadow-md appearance-none border-2 border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all cursor-pointer disabled:bg-gray-200 disabled:cursor-not-allowed"
                },
                  voices.length === 0 ? 
                    React.createElement('option', {}, "T·∫£i gi·ªçng ƒë·ªçc...") :
                    voices.map(voice => React.createElement('option', { key: voice.voiceURI, value: voice.voiceURI }, voice.name))
                ),
                React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                  React.createElement('svg', { className: "fill-current h-4 w-4", xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20" },
                    React.createElement('path', { d: "M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" })
                  )
                )
            ),
            React.createElement('button', { onClick: onChooseAnotherTopic, className: "py-3 px-8 text-lg font-bold bg-yellow-500 text-slate-800 rounded-xl shadow-md transform hover:-translate-y-1 transition-all" }, "Ch·ªçn ch·ªß ƒë·ªÅ kh√°c")
          ),
          React.createElement('div', { className: "text-xl font-bold text-purple-800 mt-4" }, `ƒêi·ªÉm: ${score} | Ho√†n th√†nh: ${currentIndex}/${sentences.length}`)
        );
      };
      
      // --- From App.tsx ---
      const App = () => {
        const [gameState, setGameState] = useState(GameState.Start);
        const [playerName, setPlayerName] = useState('');
        const [selectedTopic, setSelectedTopic] = useState('');
        const [topicSentences, setTopicSentences] = useState([]);
        const [lastScore, setLastScore] = useState({ correct: 0, total: 0 });

        const handleStart = useCallback((name) => {
          setPlayerName(name);
          setGameState(GameState.TopicSelection);
        }, []);

        const handleSelectTopic = useCallback((topicName) => {
          setSelectedTopic(topicName);
          setTopicSentences(topics[topicName]);
          setGameState(GameState.Playing);
        }, []);

        const handleTopicComplete = useCallback((correct, total) => {
          setLastScore({ correct, total });
          setGameState(GameState.Congrats);
        }, []);
        
        const handlePlayAgain = useCallback(() => {
          if (selectedTopic && topics[selectedTopic]) {
            setTopicSentences(topics[selectedTopic]);
            setGameState(GameState.Playing);
          } else {
            setGameState(GameState.TopicSelection);
          }
        }, [selectedTopic]);

        const handleChooseAnotherTopic = useCallback(() => {
          setSelectedTopic('');
          setTopicSentences([]);
          setGameState(GameState.TopicSelection);
        }, []);

        const renderScreen = () => {
          switch (gameState) {
            case GameState.Start:
              return React.createElement(StartScreen, { onStart: handleStart });
            case GameState.TopicSelection:
              return React.createElement(TopicSelectionScreen, { topics: Object.keys(topics), onSelectTopic: handleSelectTopic });
            case GameState.Playing:
              return React.createElement(GameScreen, { key: selectedTopic, sentences: topicSentences, onTopicComplete: handleTopicComplete, onChooseAnotherTopic: handleChooseAnotherTopic });
            case GameState.Congrats:
              return React.createElement(TopicCongratsScreen, {
                  playerName: playerName,
                  topicName: selectedTopic,
                  correctCount: lastScore.correct,
                  totalCount: lastScore.total,
                  onPlayAgain: handlePlayAgain,
                  onChooseAnotherTopic: handleChooseAnotherTopic,
                });
            default:
              return React.createElement(StartScreen, { onStart: handleStart });
          }
        };

        return React.createElement('div', { className: "bg-gradient-to-br from-violet-100 to-sky-100 min-h-screen w-full flex justify-center items-center p-4" },
          React.createElement('main', { className: "container mx-auto text-center p-6 max-w-4xl w-full bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl shadow-violet-200" },
            React.createElement('h1', { className: "text-3xl sm:text-4xl md:text-5xl font-extrabold text-violet-600 mb-1 [text-shadow:_1px_2px_2px_rgb(0_0_0_/_10%)]" }, "NGHE V√Ä X·∫æP T·ª™ TH√ÄNH C√ÇU"),
            React.createElement('h2', { className: "text-xl sm:text-2xl md:text-3xl text-slate-500 font-semibold mb-5" }, "(H·ªèi & ƒê√°p)"),
            renderScreen()
          )
        );
      };

      // --- From index.tsx ---
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(React.createElement(App));
    </script>
</body>
</html>
